function GT_OSGB(){this.northings=0;this.eastings=0;this.status="Undefined"}function GT_WGS84(){this.latitude=0;this.longitude=0}function GT_Math(){}GT_OSGB.prefixes=new Array(new Array("SV","SW","SX","SY","SZ","TV","TW"),new Array("SQ","SR","SS","ST","SU","TQ","TR"),new Array("SL","SM","SN","SO","SP","TL","TM"),new Array("SF","SG","SH","SJ","SK","TF","TG"),new Array("SA","SB","SC","SD","SE","TA","TB"),new Array("NV","NW","NX","NY","NZ","OV","OW"),new Array("NQ","NR","NS","NT","NU","OQ","OR"),new Array("NL","NM","NN","NO","NP","OL","OM"),new Array("NF","NG","NH","NJ","NK","OF","OG"),new Array("NA","NB","NC","ND","NE","OA","OB"),new Array("HV","HW","HX","HY","HZ","JV","JW"),new Array("HQ","HR","HS","HT","HU","JQ","JR"),new Array("HL","HM","HN","HO","HP","JL","JM"));GT_OSGB.prototype.setGridCoordinates=function(e,t){this.northings=t;this.eastings=e;this.status="OK"};GT_OSGB.prototype.setError=function(e){this.status=e};GT_OSGB.prototype._zeropad=function(e,t){var n=new String(e);while(n.length<t){n="0"+n}return n};GT_OSGB.prototype.getGridRef=function(e){if(e<0)e=0;if(e>5)e=5;var t="";var n="";if(e>0){var r=Math.floor(this.northings/1e5);var i=Math.floor(this.eastings/1e5);var t=Math.round(this.eastings%1e5);var n=Math.round(this.northings%1e5);var s=5-e;t=Math.round(t/Math.pow(10,s));n=Math.round(n/Math.pow(10,s))}var o=GT_OSGB.prefixes[r][i];return o+" "+this._zeropad(t,e)+" "+this._zeropad(n,e)};GT_OSGB.prototype.parseGridRef=function(e){var t=false;this.northings=0;this.eastings=0;var n;for(n=5;n>=1;n--){var r=new RegExp("^([A-Z]{2})\\s*(\\d{"+n+"})\\s*(\\d{"+n+"})$","i");var i=e.match(r);if(i){var s=i[1];var o=0;var u=0;if(n>0){var a=Math.pow(10,5-n);o=parseInt(i[2],10)*a;u=parseInt(i[3],10)*a}var f,l;e:for(l=0;l<GT_OSGB.prefixes.length;l++){for(f=0;f<GT_OSGB.prefixes[l].length;f++)if(GT_OSGB.prefixes[l][f]==s){this.eastings=f*1e5+o;this.northings=l*1e5+u;t=true;break e}}}}return t};GT_OSGB.prototype.getWGS84=function(){var e=0;var t=GT_Math.E_N_to_Lat(this.eastings,this.northings,6377563.396,6356256.91,4e5,-1e5,.999601272,49,-2);var n=GT_Math.E_N_to_Long(this.eastings,this.northings,6377563.396,6356256.91,4e5,-1e5,.999601272,49,-2);var r=GT_Math.Lat_Long_H_to_X(t,n,e,6377563.396,6356256.91);var i=GT_Math.Lat_Long_H_to_Y(t,n,e,6377563.396,6356256.91);var s=GT_Math.Lat_H_to_Z(t,e,6377563.396,6356256.91);var o=GT_Math.Helmert_X(r,i,s,446.448,.247,.8421,-20.4894);var u=GT_Math.Helmert_Y(r,i,s,-125.157,.1502,.8421,-20.4894);var a=GT_Math.Helmert_Z(r,i,s,542.06,.1502,.247,-20.4894);var f=GT_Math.XYZ_to_Lat(o,u,a,6378137,6356752.313);var l=GT_Math.XYZ_to_Long(o,u);var c=new GT_WGS84;c.setDegrees(f,l);return c};GT_WGS84.prototype.setDegrees=function(e,t){this.latitude=e;this.longitude=t};GT_WGS84.prototype.parseString=function(e){var t=false;var n=new String(e);var r=/([ns])\s*(\d+)[?\s]+(\d+\.\d+)\s+([we])\s*(\d+)[?\s]+(\d+\.\d+)/i;var i=n.match(r);if(i){t=true;var s=i[1]=="s"||i[1]=="S"?-1:1;var o=i[4]=="w"||i[4]=="W"?-1:1;var u=parseFloat(i[2]);var a=parseFloat(i[3]);var f=parseFloat(i[5]);var l=parseFloat(i[6]);this.latitude=s*(u+a/60);this.longitude=o*(f+l/60)}return t};GT_WGS84.prototype.isGreatBritain=function(){return this.latitude>49&&this.latitude<62&&this.longitude>-9.5&&this.longitude<2.3};GT_WGS84.prototype.isIreland=function(){return this.latitude>51.2&&this.latitude<55.73&&this.longitude>-12.2&&this.longitude<-4.8};GT_WGS84.prototype.getOSGB=function(){var e=new GT_OSGB;if(this.isGreatBritain()){var t=0;var n=GT_Math.Lat_Long_H_to_X(this.latitude,this.longitude,t,6378137,6356752.313);var r=GT_Math.Lat_Long_H_to_Y(this.latitude,this.longitude,t,6378137,6356752.313);var i=GT_Math.Lat_H_to_Z(this.latitude,t,6378137,6356752.313);var s=GT_Math.Helmert_X(n,r,i,-446.448,-.247,-.8421,20.4894);var o=GT_Math.Helmert_Y(n,r,i,125.157,-.1502,-.8421,20.4894);var u=GT_Math.Helmert_Z(n,r,i,-542.06,-.1502,-.247,20.4894);var a=GT_Math.XYZ_to_Lat(s,o,u,6377563.396,6356256.91);var f=GT_Math.XYZ_to_Long(s,o);var l=GT_Math.Lat_Long_to_East(a,f,6377563.396,6356256.91,4e5,.999601272,49,-2);var c=GT_Math.Lat_Long_to_North(a,f,6377563.396,6356256.91,4e5,-1e5,.999601272,49,-2);e.setGridCoordinates(Math.round(l),Math.round(c))}else{e.setError("Coordinate not within Great Britain")}return e};GT_Math.E_N_to_Lat=function(e,t,n,r,i,s,o,u,a){var f=3.14159265358979;var l=u*(f/180);var c=a*(f/180);var h=n*o;var p=r*o;var d=(Math.pow(h,2)-Math.pow(p,2))/Math.pow(h,2);var v=(h-p)/(h+p);var m=e-i;var g=GT_Math.InitialLat(t,s,h,l,v,p);var y=h/Math.sqrt(1-d*Math.pow(Math.sin(g),2));var b=y*(1-d)/(1-d*Math.pow(Math.sin(g),2));var w=y/b-1;var E=Math.tan(g)/(2*b*y);var S=Math.tan(g)/(24*b*Math.pow(y,3))*(5+3*Math.pow(Math.tan(g),2)+w-9*w*Math.pow(Math.tan(g),2));var x=Math.tan(g)/(720*b*Math.pow(y,5))*(61+90*(Math.tan(g)^2)+45*Math.pow(Math.tan(g),4));var T=180/f*(g-Math.pow(m,2)*E+Math.pow(m,4)*S-(m^6)*x);return T};GT_Math.E_N_to_Long=function(e,t,n,r,i,s,o,u,a){var f=3.14159265358979;var l=u*(f/180);var c=a*(f/180);var h=n*o;var p=r*o;var d=(Math.pow(h,2)-Math.pow(p,2))/Math.pow(h,2);var v=(h-p)/(h+p);var m=e-i;var g=GT_Math.InitialLat(t,s,h,l,v,p);var y=h/Math.sqrt(1-d*Math.pow(Math.sin(g),2));var b=y*(1-d)/(1-d*Math.pow(Math.sin(g),2));var w=y/b-1;var E=Math.pow(Math.cos(g),-1)/y;var S=Math.pow(Math.cos(g),-1)/(6*Math.pow(y,3))*(y/b+2*Math.pow(Math.tan(g),2));var x=Math.pow(Math.cos(g),-1)/(120*Math.pow(y,5))*(5+28*Math.pow(Math.tan(g),2)+24*Math.pow(Math.tan(g),4));var T=Math.pow(Math.cos(g),-1)/(5040*Math.pow(y,7))*(61+662*Math.pow(Math.tan(g),2)+1320*Math.pow(Math.tan(g),4)+720*Math.pow(Math.tan(g),6));var N=180/f*(c+m*E-Math.pow(m,3)*S+Math.pow(m,5)*x-Math.pow(m,7)*T);return N};GT_Math.InitialLat=function(e,t,n,r,i,s){var o=(e-t)/n+r;var u=GT_Math.Marc(s,i,r,o);var a=(e-t-u)/n+o;while(Math.abs(e-t-u)>1e-5){a=(e-t-u)/n+o;u=GT_Math.Marc(s,i,r,a);o=a}return a};GT_Math.Lat_Long_H_to_X=function(e,t,n,r,i){var s=3.14159265358979;var o=e*(s/180);var u=t*(s/180);var a=(Math.pow(r,2)-Math.pow(i,2))/Math.pow(r,2);var f=r/Math.sqrt(1-a*Math.pow(Math.sin(o),2));return(f+n)*Math.cos(o)*Math.cos(u)};GT_Math.Lat_Long_H_to_Y=function(e,t,n,r,i){var s=3.14159265358979;var o=e*(s/180);var u=t*(s/180);var a=(Math.pow(r,2)-Math.pow(i,2))/Math.pow(r,2);var f=r/Math.sqrt(1-a*Math.pow(Math.sin(o),2));return(f+n)*Math.cos(o)*Math.sin(u)};GT_Math.Lat_H_to_Z=function(e,t,n,r){var i=3.14159265358979;var s=e*(i/180);var o=(Math.pow(n,2)-Math.pow(r,2))/Math.pow(n,2);var u=n/Math.sqrt(1-o*Math.pow(Math.sin(s),2));return(u*(1-o)+t)*Math.sin(s)};GT_Math.Helmert_X=function(e,t,n,r,i,s,o){var u=3.14159265358979;var a=o*1e-6;var f=i/3600*(u/180);var l=s/3600*(u/180);return e+e*a-t*l+n*f+r};GT_Math.Helmert_Y=function(e,t,n,r,i,s,o){var u=3.14159265358979;var a=o*1e-6;var f=i/3600*(u/180);var l=s/3600*(u/180);return e*l+t+t*a-n*f+r};GT_Math.Helmert_Z=function(e,t,n,r,i,s,o){var u=3.14159265358979;var a=o*1e-6;var f=i/3600*(u/180);var l=s/3600*(u/180);return-1*e*l+t*f+n+n*a+r};GT_Math.XYZ_to_Lat=function(e,t,n,r,i){var s=Math.sqrt(Math.pow(e,2)+Math.pow(t,2));var o=(Math.pow(r,2)-Math.pow(i,2))/Math.pow(r,2);var u=Math.atan2(n,s*(1-o));var a=GT_Math.Iterate_XYZ_to_Lat(r,o,u,n,s);var f=3.14159265358979;return a*(180/f)};GT_Math.Iterate_XYZ_to_Lat=function(e,t,n,r,i){var s=e/Math.sqrt(1-t*Math.pow(Math.sin(n),2));var o=Math.atan2(r+t*s*Math.sin(n),i);while(Math.abs(n-o)>1e-9){n=o;s=e/Math.sqrt(1-t*Math.pow(Math.sin(n),2));o=Math.atan2(r+t*s*Math.sin(n),i)}return o};GT_Math.XYZ_to_Long=function(e,t){var n=3.14159265358979;return Math.atan2(t,e)*(180/n)};GT_Math.Marc=function(e,t,n,r){return e*((1+t+5/4*Math.pow(t,2)+5/4*Math.pow(t,3))*(r-n)-(3*t+3*Math.pow(t,2)+21/8*Math.pow(t,3))*Math.sin(r-n)*Math.cos(r+n)+(15/8*Math.pow(t,2)+15/8*Math.pow(t,3))*Math.sin(2*(r-n))*Math.cos(2*(r+n))-35/24*Math.pow(t,3)*Math.sin(3*(r-n))*Math.cos(3*(r+n)))};GT_Math.Lat_Long_to_East=function(e,t,n,r,i,s,o,u){var a=3.14159265358979;var f=e*(a/180);var l=t*(a/180);var c=o*(a/180);var h=u*(a/180);var p=n*s;var d=r*s;var v=(Math.pow(p,2)-Math.pow(d,2))/Math.pow(p,2);var m=(p-d)/(p+d);var g=p/Math.sqrt(1-v*Math.pow(Math.sin(f),2));var y=g*(1-v)/(1-v*Math.pow(Math.sin(f),2));var b=g/y-1;var w=l-h;var E=g*Math.cos(f);var S=g/6*Math.pow(Math.cos(f),3)*(g/y-Math.pow(Math.tan(f),2));var x=g/120*Math.pow(Math.cos(f),5)*(5-18*Math.pow(Math.tan(f),2)+Math.pow(Math.tan(f),4)+14*b-58*Math.pow(Math.tan(f),2)*b);return i+w*E+Math.pow(w,3)*S+Math.pow(w,5)*x};GT_Math.Lat_Long_to_North=function(e,t,n,r,i,s,o,u,a){var f=3.14159265358979;var l=e*(f/180);var c=t*(f/180);var h=u*(f/180);var p=a*(f/180);var d=n*o;var v=r*o;var m=(Math.pow(d,2)-Math.pow(v,2))/Math.pow(d,2);var g=(d-v)/(d+v);var y=d/Math.sqrt(1-m*Math.pow(Math.sin(l),2));var b=y*(1-m)/(1-m*Math.pow(Math.sin(l),2));var w=y/b-1;var E=c-p;var S=GT_Math.Marc(v,g,h,l);var x=S+s;var T=y/2*Math.sin(l)*Math.cos(l);var N=y/24*Math.sin(l)*Math.pow(Math.cos(l),3)*(5-Math.pow(Math.tan(l),2)+9*w);var C=y/720*Math.sin(l)*Math.pow(Math.cos(l),5)*(61-58*Math.pow(Math.tan(l),2)+Math.pow(Math.tan(l),4));return x+Math.pow(E,2)*T+Math.pow(E,4)*N+Math.pow(E,6)*C}
