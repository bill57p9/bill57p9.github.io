function getURLParameter(e){return decodeURIComponent(((new RegExp("[?|&]"+e+"="+"([^&;]+?)(&|#|;|$)")).exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null}SPOT_MESSAGE.prototype.isTrack=function(){if("TRACK"==this.type)return true;return false};SPOT_FEEDS.refresh=function(){console.log(SPOT_FEEDS);SPOT_FEEDS.update(SPOT_FEEDS.display)};SPOT_FEEDS.getHistory=function(){SPOT_FEEDS.update(SPOT_FEEDS.display,null,true)};SPOT_FEEDS.display=function(e){var t=function(e,t,n){if(!n)n="right";var r=e.insertCell(-1);r.align=n;r.innerHTML=t};var n=document.createElement("tbody");n.innerHTML="<tr><th colspan='5' align='left'>"+e.name+"</th></tr>";for(var r=0;r<e.tracker.length;r++){var i=e.tracker[r];if(!i.trackMsgs)i.trackMsgs="hide";n.insertRow(-1).innerHTML="<th colspan='5' align='left'>"+i.name+"</th>";var s=-1;if("hide"==i.trackMsgs){s=0;for(var o=0;o<i.message.length;o++)if(i.message[o].isTrack())s++}for(var o=0;o<i.message.length;o++){var u=i.message[o];var a=u.getOSGB();var f=n.insertRow(-1);f.title=u.type;t(f,DAYS[u.time.getDay()]);t(f,u.time.toLocaleTimeString());t(f,"<img src='battery_"+u.battery+".png'>");t(f,"<a href='http://www.streetmap.co.uk/newprint.srf?x="+a.eastings+"&y="+a.northings+"&z=4&ar=Y'>"+a.getGridRef(3)+"</a>");if(i.message.length-1>o){var l=i.message[o+1];t(f,(36e5*u.getDistance(l)/(u.time.getTime()-l.time.getTime())).toFixed(1)+" km/h");t(f,l.getHeading(u).toFixed(0)+" deg")}else{f.insertCell(-1);f.insertCell(-1)}if(u.isTrack()){if("hide"==i.trackMsgs){if(0==s)f.style.display="none";else{t(f,"TRACK <a href='javascript:SPOT_FEEDS.trackMsgDisplay(\""+e.id+'",'+r+',"show");\'><i>('+(s-1)+" hidden)</i></a>","left");s=0}}else t(f,"TRACK <a href='javascript:SPOT_FEEDS.trackMsgDisplay(\""+e.id+'",'+r+',"hide");\'><i>(hide old)</i></a>',"left")}else t(f,u.type,"left")}}var c=document.getElementById("tblMessages");if(c.tBodies[e.id])c.tBodies[e.id].innerHTML=n.innerHTML;else{n.id=e.id;c.appendChild(n)}document.getElementById("updateTimestamp").innerHTML=SPOT_FEEDS.feed[0].lastUpdated.toLocaleTimeString()+" "+DAYS[SPOT_FEEDS.feed[0].lastUpdated.getDay()]+" "+SPOT_FEEDS.feed[0].lastUpdated.toLocaleDateString();SPOT_FEEDS.updateTimer()};SPOT_FEEDS.trackMsgDisplay=function(e,t,n){var r=SPOT_FEEDS.getFeed(e);r.tracker[t].trackMsgs=n;SPOT_FEEDS.display(r)};SPOT_FEEDS.updateTimeout=null;SPOT_FEEDS.updateTimer=function(){if(SPOT_FEEDS.updateTimeout)clearTimeout(SPOT_FEEDS.updateTimeout);var e=document.getElementById("updateInterval");var t=e.options[e.selectedIndex].value;if(t>0){var n=new Date;t*=6e4;t-=n.getTime()-SPOT_FEEDS.feed[0].lastUpdated.getTime();console.log(t);if(t>0)SPOT_FEEDS.updateTimeout=setTimeout(SPOT_FEEDS.refresh,t);else SPOT_FEEDS.refresh()}};var DAYS=new Array("Sun","Mon","Tue","Wed","Thu","Fri","Sat");SPOT_FEEDS.addFeed(getURLParameter("feed"));SPOT_FEEDS.refresh()
